<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Escape Game - Devinettes</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: url('https://www.transparenttextures.com/patterns/stardust.png') repeat black;
      color: white;
      overflow-x: hidden;
      font-size: 16px;
    }
    .screen {
      min-height: 100vh;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 5vw;
      max-width: 600px;
      margin: auto;
      text-align: center;
    }
    .active {
      display: flex;
    }
    h1 {
      font-size: clamp(24px, 6vw, 36px);
      margin-bottom: 1em;
    }
    p, select {
      max-width: 90%;
      font-size: clamp(14px, 4.5vw, 20px);
      margin-bottom: 1.5em;
    }
    button, input, select {
      font-size: clamp(16px, 4.5vw, 22px);
      padding: 0.6em 1.2em;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin: 0.5em;
    }
    #lives {
      font-size: clamp(20px, 6vw, 30px);
      margin-bottom: 10px;
    }
    #timer {
      margin-bottom: 1em;
      font-weight: bold;
    }
    .step-image {
      width: 80%;
      max-width: 150px;
      height: auto;
      border-radius: 10px;
      margin-bottom: 1em;
      object-fit: cover;
    }
    #message {
      margin-top: 1em;
      font-weight: bold;
    }
    .key {
      width: 60px;
      display: none;
      margin-top: 10px;
      animation: fadeIn 1s ease;
    }
    .show {
      display: inline-block !important;
    }
    #darkness {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      background: radial-gradient(circle at 50% 50%, transparent 100px, rgba(0,0,0,0.95) 200px);
      transition: background 0.2s ease-out;
      z-index: 5;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.5); }
      to { opacity: 1; transform: scale(1); }
    }
  </style>
</head>
<body>

<div id="menu" class="screen active">
  <h1>Choisis une option</h1>
  <select id="choice">
    <option value="1">1 - Devinettes classiques</option>
    <option value="2">2 - Autre option</option>
  </select>
  <button onclick="handleSelection()">Valider</button>
</div>

<div id="intro" class="screen">
  <h1>√âvasion Nocturne</h1>
  <p>Tu te r√©veilles dans une pi√®ce obscure. Trois √©nigmes al√©atoires gardent la sortie. Tu as 10 minutes pour t‚Äô√©chapper...</p>
  <button onclick="startGame()">Commencer</button>
</div>

<div id="bien" class="screen">
  <h1>bien</h1>
</div>

<div id="darkness"></div>

<div id="game" class="screen">
  <h2>Escape Game : Devinettes</h2>
  <div id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
  <div id="timer">‚è±Ô∏è Temps restant : 10:00</div>
  <img id="stepImage" class="step-image" src="" alt="Image √©nigme">
  <div id="stepText"></div>
  <input type="text" id="answerInput" placeholder="Ta r√©ponse ici">
  <button id="validateBtn" onclick="checkAnswer()">Valider</button>
  <div id="message"></div>
  <img id="keyImage" class="key" src="https://cdn-icons-png.flaticon.com/512/2721/2721260.png" alt="Cl√©">
</div>

<audio id="successSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_d51d4d1cd5.mp3" preload="auto"></audio>
<audio id="errorSound" src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_3f7b5dc872.mp3" preload="auto"></audio>
<audio id="bgMusic" src="https://cdn.pixabay.com/download/audio/2022/03/30/audio_6c02fefee4.mp3" autoplay loop preload="auto"></audio>

<script>
function handleSelection() {
  const val = document.getElementById("choice").value;
  document.getElementById("menu").classList.remove("active");
  if (val === "1") {
    document.getElementById("intro").classList.add("active");
  } else {
    document.getElementById("bien").classList.add("active");
  }
}

const sharedImage = "https://cdn.pixabay.com/photo/2021/06/06/06/24/lock-6314371_1280.png";

const allSteps = [
  { question: "üîí Le double de 17 te lib√©rera.", answer: "34", synonyms: ["trente-quatre"], image: sharedImage },
  { question: "üïØÔ∏è Je suis plus l√©ger que l‚Äôair, mais je peux t‚Äôemporter loin‚Ä¶", answer: "r√™ve", synonyms: ["un r√™ve", "songes", "imagination"], image: sharedImage },
  { question: "üî• Je suis la couleur du feu‚Ä¶ et de la passion.", answer: "rouge", synonyms: ["le rouge", "feu", "√©carlate"], image: sharedImage },
  { question: "üß† Plus tu en prends, plus tu laisses derri√®re toi.", answer: "pas", synonyms: ["empreinte", "traces", "marche"], image: sharedImage },
  { question: "üå´Ô∏è Je disparais quand on me nomme‚Ä¶", answer: "silence", synonyms: ["le silence", "silencieux", "absence de bruit"], image: sharedImage },
  { question: "‚è≥ J‚Äôavance sans jamais reculer. Que suis-je ?", answer: "temps", synonyms: ["le temps", "minute", "seconde"], image: sharedImage },
  { question: "üíß Si tu me nommes, je ne suis plus. Que suis-je ?", answer: "secret", synonyms: ["un secret", "le secret"], image: sharedImage },
  { question: "ü™û J‚Äôexiste quand tu me regardes, mais je disparais si tu tournes le dos.", answer: "reflet", synonyms: ["le reflet", "miroir", "image"], image: sharedImage },
  { question: "üö™ Plus tu en prends, plus tu laisses derri√®re toi. Que suis-je ?", answer: "pas", synonyms: ["traces", "empreintes"], image: sharedImage },
  { question: "üì¶ Plus je suis vide, plus je p√®se. Que suis-je ?", answer: "trou", synonyms: ["un trou", "vide"], image: sharedImage },
];

function getRandomSteps(array, count = 3) {
  return [...array].sort(() => Math.random() - 0.5).slice(0, count);
}

function normalize(str) {
  return str
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-zA-Z0-9\s]/g, "")
    .replace(/\b(le|la|un|une|des|de|du|les|et|en)\b/g, "")
    .replace(/\s+/g, " ")
    .trim();
}

let steps = [];
let currentStep = 0;
let timeLeft = 600;
let lives = 3;
let timerInterval;

const stepText = document.getElementById("stepText");
const stepImage = document.getElementById("stepImage");
const keyImage = document.getElementById("keyImage");
const answerInput = document.getElementById("answerInput");
const message = document.getElementById("message");
const successSound = document.getElementById("successSound");
const errorSound = document.getElementById("errorSound");
const timerDisplay = document.getElementById("timer");
const validateBtn = document.getElementById("validateBtn");
const livesDisplay = document.getElementById("lives");
const darkness = document.getElementById("darkness");

function startGame() {
  document.getElementById("intro").classList.remove("active");
  document.getElementById("game").classList.add("active");
  steps = getRandomSteps(allSteps);
  currentStep = 0;
  lives = 3;
  timeLeft = 600;
  livesDisplay.textContent = "‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è";
  document.getElementById("bgMusic").volume = 0.3;
  showStep();
  startTimer();
  enableGyroscopeTorch();
}

function showStep() {
  stepText.innerHTML = steps[currentStep].question;
  stepImage.src = steps[currentStep].image;
  answerInput.value = '';
  message.textContent = '';
  keyImage.classList.remove("show");
  answerInput.focus();
}

function checkAnswer() {
  const userInput = answerInput.value.trim();
  const normalizedInput = normalize(userInput);
  const acceptedAnswers = [steps[currentStep].answer, ...(steps[currentStep].synonyms || [])];
  const match = acceptedAnswers.some(a => normalizedInput.includes(normalize(a)));

  if (match) {
    successSound.play();
    keyImage.classList.add("show");
    setTimeout(() => {
      currentStep++;
      if (currentStep < steps.length) showStep();
      else endGame(true);
    }, 1500);
  } else {
    errorSound.play();
    lives--;
    livesDisplay.textContent = "‚ù§Ô∏è".repeat(lives) + "üñ§".repeat(3 - lives);
    message.textContent = "‚ùå Mauvaise r√©ponse, essaie encore.";
    if (lives <= 0) endGame(false, "üíÄ Tu as perdu toutes tes vies...");
  }
}

function startTimer() {
  timerInterval = setInterval(() => {
    timeLeft--;
    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      endGame(false, "‚õî Temps √©coul√© ! Tu es rest√© enferm√©...");
    } else {
      const m = Math.floor(timeLeft / 60), s = timeLeft % 60;
      timerDisplay.textContent = `‚è±Ô∏è Temps restant : ${m}:${s < 10 ? '0' : ''}${s}`;
    }
  }, 1000);
}

function endGame(success, msg = '') {
  clearInterval(timerInterval);
  stepText.innerHTML = success ? "üéâ Bravo ! Tu t'es √©chapp√© !" : msg;
  answerInput.style.display = "none";
  validateBtn.style.display = "none";
  livesDisplay.textContent = '';
  const btn = document.createElement("button");
  btn.textContent = "üîÅ Rejouer";
  btn.onclick = () => location.reload();
  document.getElementById("game").appendChild(btn);
}

document.addEventListener("mousemove", e => {
  darkness.style.background = `radial-gradient(circle at ${e.clientX}px ${e.clientY}px, transparent 100px, rgba(0,0,0,0.95) 200px)`;
});

document.addEventListener("touchmove", e => {
  const t = e.touches[0];
  darkness.style.background = `radial-gradient(circle at ${t.clientX}px ${t.clientY}px, transparent 100px, rgba(0,0,0,0.95) 200px)`;
});

function enableGyroscopeTorch() {
  if (typeof DeviceOrientationEvent !== "undefined" && typeof DeviceOrientationEvent.requestPermission === "function") {
    DeviceOrientationEvent.requestPermission().then(state => {
      if (state === "granted") window.addEventListener("deviceorientation", handleGyroTorch);
    }).catch(console.error);
  } else {
    window.addEventListener("deviceorientation", handleGyroTorch);
  }
}

function handleGyroTorch(e) {
  const x = window.innerWidth / 2 + (e.gamma || 0) * 10;
  const y = window.innerHeight / 2 + (e.beta || 0) * 10;
  darkness.style.background = `radial-gradient(circle at ${x}px ${y}px, transparent 100px, rgba(0,0,0,0.95) 200px)`;
}
</script>
</body>
</html>
